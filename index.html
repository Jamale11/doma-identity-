<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Doma ID Generator with Custom Background</title>

  <!-- Tailwind -->
  <script src="dome.png"></script>

  <style>
    body {
      background: linear-gradient(135deg,#1e40af,#2563eb,#3b82f6);
    }
    canvas {
      border: 4px solid #3b82f6;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(2,6,23,0.5);
      background: transparent;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6 text-white">

  <h1 class="text-3xl font-extrabold mb-6">‚ú® Doma ID Card Generator</h1>

  <div class="bg-white text-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-md mb-6 space-y-4">
    <!-- Nama -->
    <div>
      <label class="block mb-1 font-semibold text-blue-700">Name:</label>
      <input id="nameInput" type="text" placeholder="Enter name"
             class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400">
    </div>

    <!-- Your ID -->
    <div>
      <label class="block mb-1 font-semibold text-blue-700">Your ID:</label>
      <input id="idInput" type="text" placeholder="Enter ID (ex: user123)"
             class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400">
    </div>

    <!-- Profile Link -->
    <div>
      <label class="block mb-1 font-semibold text-blue-700">Profile Link:</label>
      <input id="linkInput" type="text" placeholder="https://example.com"
             class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400">
    </div>

    <!-- Upload Avatar -->
    <div>
      <label class="block mb-1 font-semibold text-blue-700">Upload Avatar / Logo:</label>
      <label class="inline-flex items-center gap-3 px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700">
        <span>Choose File</span>
        <input id="avatarInput" type="file" accept="image/*" class="hidden">
      </label>
      <span id="avatarFileName" class="ml-2 text-sm text-gray-600">No file chosen</span>
    </div>

    <!-- Buttons -->
    <div class="space-y-2 pt-2">
      <button id="btnGenerate" onclick="generateID()"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg">
        üé® Generate ID Card
      </button>
      <button onclick="downloadID()"
              class="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-bold px-4 py-2 rounded-lg">
        ‚¨áÔ∏è Download ID Card
      </button>
    </div>
  </div>

  <canvas id="idCanvas" width="620" height="360"></canvas>

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    const canvas = document.getElementById("idCanvas");
    const ctx = canvas.getContext("2d");

    let avatarImg = null; 
    const bgImg = new Image();
    bgImg.src = "dome.png"; // background desain kamu

    // helper wait image loaded
    function waitImageLoaded(img) {
      return new Promise((resolve) => {
        if (!img) return resolve();
        if (img.complete && img.naturalWidth !== 0) return resolve();
        img.onload = () => resolve();
        img.onerror = () => resolve();
      });
    }

    // Avatar upload
    document.getElementById("avatarInput").addEventListener("change", function(e) {
      const fileName = e.target.files.length > 0 ? e.target.files[0].name : "No file chosen";
      document.getElementById("avatarFileName").textContent = fileName;

      if (!e.target.files[0]) {
        avatarImg = null;
        return;
      }
      const reader = new FileReader();
      reader.onload = function(ev) {
        avatarImg = new Image();
        avatarImg.src = ev.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    // QR generator helper
    function createQRDataURL(text, size = 120) {
      return new Promise((resolve, reject) => {
        const wrapper = document.createElement("div");
        wrapper.style.position = "fixed";
        wrapper.style.left = "-9999px";
        wrapper.style.top = "-9999px";
        document.body.appendChild(wrapper);

        try {
          new QRCode(wrapper, {
            text: text,
            width: size,
            height: size,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
        } catch (err) {
          document.body.removeChild(wrapper);
          return reject(err);
        }

        const observer = new MutationObserver(() => {
          const img = wrapper.querySelector("img");
          if (img) {
            observer.disconnect();
            const src = img.src;
            document.body.removeChild(wrapper);
            return resolve(src);
          }
        });
        observer.observe(wrapper, { childList: true, subtree: true });

        setTimeout(() => {
          const img = wrapper.querySelector("img");
          if (img) {
            observer.disconnect();
            const src = img.src;
            document.body.removeChild(wrapper);
            return resolve(src);
          } else {
            observer.disconnect();
            document.body.removeChild(wrapper);
            return reject(new Error("QR generation timeout"));
          }
        }, 2000);
      });
    }

    // Generate ID
    async function generateID() {
      const name = document.getElementById("nameInput").value.trim() || "Anonymous";
      const userId = document.getElementById("idInput").value.trim() || "ID-0000";
      const link = document.getElementById("linkInput").value.trim() || "https://rialo.fun";

      const btn = document.getElementById("btnGenerate");
      btn.disabled = true;
      btn.textContent = "Generating‚Ä¶";

      try {
        await waitImageLoaded(bgImg);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

        // Avatar
        await waitImageLoaded(avatarImg);
        const avatarX = 60, avatarY = 90, avatarR = 70;
        ctx.save();
        ctx.beginPath();
        ctx.arc(avatarX, avatarY, avatarR, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();
        if (avatarImg) {
          const boxSize = avatarR * 2;
          const iw = avatarImg.naturalWidth, ih = avatarImg.naturalHeight;
          const aspect = Math.max(boxSize / iw, boxSize / ih);
          const dw = iw * aspect, dh = ih * aspect;
          const dx = avatarX - dw/2, dy = avatarY - dh/2;
          ctx.drawImage(avatarImg, dx, dy, dw, dh);
        }
        ctx.restore();

        // Text
        ctx.fillStyle = "white";
        ctx.font = "bold 26px Arial";
        ctx.fillText(name, 160, 110);
        ctx.fillStyle = "yellow";
        ctx.font = "20px Arial";
        ctx.fillText(userId, 160, 145);

        // QR
        const qrDataUrl = await createQRDataURL(link, 140);
        const qrImg = new Image();
        qrImg.src = qrDataUrl;
        await waitImageLoaded(qrImg);
        ctx.drawImage(qrImg, canvas.width - 160, canvas.height - 150, 120, 120);

      } finally {
        btn.disabled = false;
        btn.textContent = "üé® Generate ID Card";
      }
    }

    // Download ID
    function downloadID() {
      const link = document.createElement("a");
      link.download = "doma-id.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }
  </script>
</body>
</html>
